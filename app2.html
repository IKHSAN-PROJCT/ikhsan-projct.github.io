<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #e5ddd5;
        }
        .chat-container {
            width: 360px;
            height: 640px;
            margin: 0 auto;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background-color: #075e54;
            color: #ffffff;
            padding: 15px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        .messages {
            flex: 1;
            padding: 10px;
            overflow-y: scroll;
        }
        .message {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            position: relative;
        }
        .message.outgoing {
            align-items: flex-end;
        }
        .message.incoming {
            align-items: flex-start;
        }
        .message .text {
            max-width: 60%;
            padding: 10px;
            border-radius: 10px;
            font-size: 16px;
            line-height: 1.4;
        }
        .message.outgoing .text {
            background-color: #dcf8c6;
        }
        .message.incoming .text {
            background-color: #ffffff;
            border: 1px solid #ddd;
        }
        .input-container {
            display: flex;
            align-items: center;
            padding: 10px;
            border-top: 1px solid #ddd;
            background-color: #ffffff;
        }
        .input-container textarea {
            flex: 1;
            border: none;
            border-radius: 20px;
            padding: 10px;
            resize: none;
            font-size: 16px;
            background-color: #f1f1f1;
        }
        .input-container button {
            border: none;
            background-color: #075e54;
            color: #ffffff;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            margin-left: 10px;
        }
        .user-profile {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .user-profile img {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }
        .user-profile .username {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            Chat
        </div>
        <div class="messages" id="messagesContainer">
            <!-- Messages will be dynamically added here -->
        </div>
        <div class="input-container">
            <textarea id="messageInput" rows="2" placeholder="Type a message..."></textarea>
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        const POLLING_INTERVAL = 5000; // Interval for polling messages (5 seconds)
        const IP_INFO_API_KEY = '75dbf422b18639'; // Replace with your IP info API key

        let lastUpdateId = 0;
        const messagesShown = new Set();

        function getBotToken() {
            let token = localStorage.getItem('telegram_bot_token');
            if (!token) {
                token = prompt('Please enter your Telegram bot token:');
                if (token) {
                    localStorage.setItem('telegram_bot_token', token);
                } else {
                    alert('Token is required to use the chat.');
                }
            }
            return token;
        }

        function sendMessage() {
            const token = getBotToken();
            if (!token) return;

            const message = document.getElementById('messageInput').value;
            if (message.trim() === '') return;

            try {
                fetch(`https://api.telegram.org/bot${token}/getUpdates`)
                    .then(response => response.json())
                    .then(result => {
                        if (result.ok) {
                            const updates = result.result;
                            updates.forEach(update => {
                                if (update.message && !messagesShown.has(update.message.message_id)) {
                                    messagesShown.add(update.message.message_id);
                                    const chatId = update.message.chat.id;

                                    const payload = {
                                        chat_id: chatId,
                                        text: message
                                    };

                                    fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify(payload)
                                    })
                                    .then(response => response.json())
                                    .then(result => {
                                        if (result.ok) {
                                            const messageContainer = document.createElement('div');
                                            messageContainer.className = 'message outgoing';
                                            messageContainer.innerHTML = `<div class="text">${message}</div>`;
                                            document.getElementById('messagesContainer').appendChild(messageContainer);
                                            document.getElementById('messageInput').value = '';
                                        } else {
                                            console.error('Failed to send message', result);
                                        }
                                    })
                                    .catch(error => console.error('Error:', error));
                                }
                            });
                        } else {
                            console.error('Failed to get updates', result);
                        }
                    })
                    .catch(error => console.error('Error:', error));
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function fetchMessages() {
            const token = getBotToken();
            if (!token) return;

            fetch(`https://api.telegram.org/bot${token}/getUpdates?offset=${lastUpdateId + 1}`)
                .then(response => response.json())
                .then(result => {
                    if (result.ok) {
                        const updates = result.result;
                        updates.forEach(async update => {
                            if (update.message && !messagesShown.has(update.message.message_id)) {
                                messagesShown.add(update.message.message_id);
                                lastUpdateId = update.update_id;

                                const chatId = update.message.chat.id;
                                const text = update.message.text;
                                const from = update.message.from;
                                const userName = from.username ? from.username : from.first_name + ' ' + (from.last_name || '');
                                const profilePic = await getUserProfilePicture(from.id);

                                // Simpan informasi pengguna ke localStorage
                                const userData = {
                                    chatId,
                                    firstName: from.first_name,
                                    lastName: from.last_name || '',
                                    userName,
                                    profilePic
                                };
                                localStorage.setItem(`user_${from.id}`, JSON.stringify(userData));

                                // Get IP-based geolocation
                                const ipResponse = await fetch(`https://ipinfo.io/json?token=${IP_INFO_API_KEY}`);
                                const ipInfo = await ipResponse.json();
                                const country = ipInfo.country || 'Unknown';
                                const city = ipInfo.city || 'Unknown';

                                // Add the incoming message with user info to the chat
                                const messageContainer = document.createElement('div');
                                messageContainer.className = 'message incoming';
                                messageContainer.innerHTML = `
                                    <div class="user-profile">
                                        <img src="${profilePic}" alt="Profile Picture">
                                        <div class="username">${userName}</div>
                                    </div>
                                    <div class="text">${text}</div>
                                    <div class="user-info">
                                        <div><strong>üñºÔ∏è Foto Profil:</strong> <img src="${profilePic}" alt="Profile Picture" style="width: 50px; height: 50px;"></div>
                                        <div><strong>üë§ Nama:</strong> ${from.first_name} ${from.last_name || ''}</div>
                                        <div><strong>üì± Username:</strong> ${userName}</div>
                                        <div><strong>üÜî Chat ID:</strong> ${chatId}</div>
                                        <div><strong>üáÆüá© Negara:</strong> ${country}</div>
                                        <div><strong>üèôÔ∏è Kota:</strong> ${city}</div>
                                    </div>
                                `;
                                document.getElementById('messagesContainer').appendChild(messageContainer);
                            }
                        });
                    } else {
                        console.error('Failed to get updates', result);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function getUserProfilePicture(userId) {
            const token = getBotToken();
            if (!token) return;

            return fetch(`https://api.telegram.org/bot${token}/getUserProfilePhotos`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_id: userId })
            })
            .then(response => response.json())
            .then(result => {
                if (result.ok && result.result && result.result.photos.length > 0) {
                    const photos = result.result.photos;
                    const photo = photos[0][0]; // Get the first photo
                    const fileId = photo.file_id;

                    return fetch(`https://api.telegram.org/bot${token}/getFile?file_id=${fileId}`)
                        .then(response => response.json())
                        .then(fileResult => {
                            if (fileResult.ok) {
                                const filePath = fileResult.result.file_path;
                                return `https://api.telegram.org/file/bot${token}/${filePath}`;
                            } else {
                                console.error('Failed to get file path', fileResult);
                                return 'default-profile-pic-url'; // Default profile picture URL if failed
                            }
                        });
                } else {
                    return 'default-profile-pic-url'; // Default profile picture URL if no photos
                }
            })
            .catch(error => {
                console.error('Error fetching profile picture:', error);
                return 'default-profile-pic-url'; // Default profile picture URL on error
            });
        }

        // Poll messages periodically
        setInterval(fetchMessages, POLLING_INTERVAL);
    </script>
</body>
</html>